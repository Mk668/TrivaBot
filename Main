# bot.py
import os
from os import path
import random
import time
import asyncio
import discord
import random
import csv
from dotenv import load_dotenv
from discord.ext.commands import Bot
from discord.ext import commands
#edit
load_dotenv()
TOKEN = os.getenv('DISCORD_TOKEN')
GUILD = os.getenv('DISCORD_GUILD')

client = discord.Client()
bot = commands.Bot(command_prefix='$')


@bot.command(pass_context=True)
async def test(ctx):
    await ctx.send('test')


@bot.command(pass_context=True)
@commands.has_permissions(administrator=True)
async def whoami(ctx):
    msg = "You're an admin {}".format(ctx.message.author.mention)
    await ctx.send(msg)

@bot.command(pass_context=True)
@commands.has_permissions(administrator=True)
async def spam(ctx, *args):
    i = 0
    while (i < 20):
        i += 1
        await ctx.send(' '.join(args))

@bot.command(pass_context=True)
async def randomMember(ctx):
    for guild in bot.guilds:
        if guild.name == GUILD:
            break
    members = []
    for member in guild.members:
        members.append(member)
    await ctx.send(random.choice(members))


@bot.command(pass_context=True)
async def quizme(ctx):
    #quizme
    offset = random.randrange(172967)
    print(offset)
    f = open('quiz.csv')
    f.seek(offset)  # go to random position
    try:
        f.readline()  # discard - bound to be partial line
        random_line = f.readline()
    except:
        if len(random_line) == 0:  # we have hit the end
            f.seek(0)
            random_line = f.readline()
    print(random_line)

    question, answer = random_line.split("?")
    answer = answer[1:]
    answer = answer.rstrip('\n')
    await ctx.send(question)
    print("!"+answer.lower()+"!")
    def check(m):
        print('checking')
        if m.author == bot.user:
            print("Is bot")
            return False
        else:
            print("Is user")
            return True

    time.sleep(2)
    msg = await bot.wait_for('message', check=check)
    print("Message was: " + msg.content)
    if(msg.content.lower() == answer.lower()):
        await ctx.channel.send("Correct! +10 points")
    else:
        await ctx.channel.send("WRONG! Correct answer is: " + answer.lower())
    f.close()


@bot.command(pass_context=True)
async def randomMemberRole(ctx,text):
    for guild in bot.guilds:
        if guild.name == GUILD:
            break
    members = []
    for role in guild.roles:
        if role.name == text:
            for guild in bot.guilds:
                for member in guild.members:
                    if role in member.roles:
                        members.append(member)
            break
    await ctx.send(random.choice(members))


spacer = -1
@bot.event
async def on_ready():
    print(f'{bot.user} has connected to Discord!')
    for guild in bot.guilds:
        if guild.name == GUILD:
            break
    print(
        f'{bot.user} is connected to the following guild:\n'
        f'{guild.name}(id: {guild.id})'
    )

    members = '\n - '.join([member.name for member in guild.members])
    roles = '\n - '.join([role.name + " " + str(role.id) for role in guild.roles])
    if path.exists('data.csv')== False:
        with open('data.csv', mode='w') as data:
            datawriter = csv.writer(data, delimiter=',', quotechar='"', quoting=csv.QUOTE_MINIMAL)
            datawriter.writerow(['Name', 'ID', 'Score'])
            print("csv created")

    else:
        print('data file already exists')

async def spongebobmock(message):
    if message.author.name == '*****':
        print(spacer)
        spacer += 1
        print("Adding spacer")
        print(spacer)
        a = list(message.content)
        a[2::3] = [x.upper() for x in a[2::3]]
        a[1::2] = [x.lower() for x in a[1::2]]
        s = ''.join(a)
        await message.channel.send(s)
        await message.channel.send(file=discord.File('mockingspongebobbb.jpg'))





async def messageResponses(message):
    if message.author == bot.user:
        return
    if 'your mom' in message.content.lower():
        await message.channel.send('HAHAHA SO FUNNY xd')
    if 'joe' in message.content.lower():
        await message.channel.send('JOE MOMMA')
    if '@everyone' in message.content:
        await message.channel.send('You are being annoying')
    if 'trash bot' in message.content:
        await message.channel.send("That's not very nice, I'm hurt :(")



@bot.event
async def on_message(message):
    print(">" + message.content)
    await messageResponses(message)
    await bot.process_commands(message)








bot.run(TOKEN)
